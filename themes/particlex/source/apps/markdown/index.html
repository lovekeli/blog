<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown with Code and Math</title>
    <!-- 引入 highlight.js 的样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <!-- 引入 katex 的样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
        integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <!-- 引入 markdown-it 库 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <!-- 引入 highlight.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- 引入 katex 库 -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"
        integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx"
        crossorigin="anonymous"></script>
    <!-- 引入 katex 的自动渲染插件 -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    <style>
        /* 代码块容器样式 */
        pre {
            position: relative;
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }

        /* 复制按钮样式 */
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* 行号样式 */
        pre code {
            counter-reset: line;
        }

        pre code .line::before {
            counter-increment: line;
            content: counter(line);
            display: inline-block;
            padding: 0 0.5em;
            margin-right: 0.5em;
            color: #888;
            border-right: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <div id="markdown-content"></div>
    <script>
        // 初始化 markdown-it 实例
        const md = window.markdownit({
            html: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(str, { language: lang }).value;
                    } catch (__) { }
                }
                return ''; // 使用默认的不转义处理
            }
        });

        // 获取 URL 参数中的 Markdown 文本地址
        const urlParams = new URLSearchParams(window.location.search);
        const markdownUrl = urlParams.get('url');

        if (markdownUrl) {
            // 从指定地址获取 Markdown 内容
            fetch(markdownUrl)
              .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应异常');
                    }
                    return response.text();
                })
              .then(markdownText => {
                    // 解析 Markdown 文本
                    const htmlContent = md.render(markdownText);

                    // 将解析后的 HTML 插入到页面中
                    const markdownContentDiv = document.getElementById('markdown-content');
                    markdownContentDiv.innerHTML = htmlContent;

                    // 添加复制按钮和行号
                    const codeBlocks = document.querySelectorAll('pre code');
                    codeBlocks.forEach((codeBlock) => {
                        // 添加复制按钮
                        const copyBtn = document.createElement('button');
                        copyBtn.textContent = '复制';
                        copyBtn.classList.add('copy-btn');
                        copyBtn.addEventListener('click', () => {
                            const text = codeBlock.textContent;
                            navigator.clipboard.writeText(text).then(() => {
                                copyBtn.textContent = '已复制';
                                setTimeout(() => {
                                    copyBtn.textContent = '复制';
                                }, 2000);
                            }).catch((err) => {
                                console.error('复制失败: ', err);
                            });
                        });
                        const pre = codeBlock.parentNode;
                        pre.appendChild(copyBtn);

                        // 添加行号
                        const lines = codeBlock.textContent.split('\n');
                        codeBlock.innerHTML = '';
                        lines.forEach((line) => {
                            const span = document.createElement('span');
                            span.classList.add('line');
                            span.textContent = line;
                            codeBlock.appendChild(span);
                            codeBlock.appendChild(document.createElement('br'));
                        });
                    });
                })
              .catch(error => {
                    console.error('获取 Markdown 内容时出错: ', error);
                });
        } else {
            console.error('未提供 Markdown 文本的地址');
        }
    </script>
</body>

</html>    